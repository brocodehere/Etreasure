---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { fetchOffers } from '../../lib/api';

export async function getStaticPaths() {
  try {
    // Fetch all products to get their IDs and slugs for static generation
    const API_URL = 'https://etreasure-1.onrender.com';
    const response = await fetch(`${API_URL}/api/products?limit=100`);
    
    if (!response.ok) {
      return [];
    }
    
    const data = await response.json();
    const products = data.items || [];
    
    // Generate paths for both ID and slug to match different URL generation methods
    const paths = [];
    
    // Fetch full product details for each product to get images
    for (const product of products) {
      try {
        // Get full product details including images - use slug instead of ID
        const productResponse = await fetch(`${API_URL}/api/products/${product.slug}`);
        if (productResponse.ok) {
          const fullProductData = await productResponse.json();
          
          // Transform product data to ensure consistent structure
          const transformedProduct = {
            uuid_id: fullProductData.id,
            slug: fullProductData.slug,
            title: fullProductData.title,
            subtitle: fullProductData.subtitle,
            description: fullProductData.description,
            price_cents: fullProductData.price_cents,
            currency: fullProductData.currency,
            availability: fullProductData.availability,
            hero_image: fullProductData.hero_image,
            images: fullProductData.images || [], // Use images from detailed API response
            // Add fallback fields for compatibility
            name: fullProductData.title,
            image: fullProductData.hero_image?.url,
            image_url: fullProductData.hero_image?.url,
            published: true,
            category: fullProductData.category,
            stock_status: fullProductData.stock_status
          };
          
          // Add path for product ID
          if (product.id) {
            paths.push({
              params: { id: product.id },
              props: { product: transformedProduct }
            });
          }
          
          // Add path for product slug (if different from ID)
          if (product.slug && product.slug !== product.id) {
            // Add original slug
            paths.push({
              params: { id: product.slug },
              props: { product: transformedProduct }
            });
            
            // Add URL-encoded slug for browsers
            const encodedSlug = encodeURIComponent(product.slug);
            if (encodedSlug !== product.slug) {
              paths.push({
                params: { id: encodedSlug },
                props: { product: transformedProduct }
              });
            }
          }
        } else {
          // Failed to fetch product details, continue with next product
        }
      } catch (error) {
        // Failed to fetch details for product, continue with next product
      }
    }
    
    return paths;
  } catch (error) {
    return [];
  }
}

const API_URL = 'https://etreasure-1.onrender.com';

const { id } = Astro.params;

// Get product from getStaticPaths props or fetch at runtime
let product = Astro.props.product || null;

// If no product from props (development mode), fetch at runtime
if (!product) {
  // Use absolute URL for server-side rendering with proper URL encoding
  const encodedId = encodeURIComponent(id);
  const fullUrl = `${API_URL}/api/products/${encodedId}?t=${Date.now()}`;

  try {
    const response = await fetch(fullUrl, {
      headers: {
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache'
      }
    });
    if (response.ok) {
      const data = await response.json();
      // Transform the API response to match expected format
      product = {
        uuid_id: data.id,
        slug: data.slug,
        title: data.title,
        subtitle: data.subtitle,
        description: data.description,
        price_cents: data.price_cents,
        currency: data.currency,
        availability: data.availability,
        hero_image: data.hero_image,
        images: data.images || [], // Multiple images array
        category_id: data.category_id, // Add category_id
        variants: data.variants || [], // Add variants from the response
        // Add fallback fields for compatibility
        name: data.title,
        image: data.hero_image?.url,
        image_url: data.hero_image?.url,
        published: true, // PublicGet only returns published products
      };
    }
  } catch (error) {
    // Failed to fetch product details
  }
}

// If no product found, redirect to shop
if (!product) {
  return Astro.redirect('/shop');
}

// Fetch offers to check for applicable discounts
const offersResponse = await fetchOffers();
const offers = offersResponse.items || [];

// Filter active offers
const activeOffers = offers.filter(offer => 
  offer.is_active && 
  new Date(offer.ends_at) > new Date()
);

// Fetch product variants to check product-specific offers
let productVariants = [];
try {
  // Use public endpoint with variants field
  // Use product.slug instead of product.id since PublicGet expects a slug
  const variantsResponse = await fetch(`${API_URL}/api/products/${product.slug}?fields=variants`);
  if (variantsResponse.ok) {
    const variantsData = await variantsResponse.json();
    productVariants = variantsData.variants || [];
  }
} catch (error) {
  console.log('Failed to fetch variants from public endpoint:', error);
}

// Debug logging - log full product data to see available fields
console.log('Full product data:', JSON.stringify(product, null, 2));
console.log('Product variants from response:', productVariants);
console.log('Product data:', {
  title: product.title,
  category_id: product.category_id,
  category: product.category,
  price_cents: product.price_cents
});
console.log('All offers:', offers);
console.log('Active offers:', activeOffers);

// Find applicable offers for this product
const applicableOffers = activeOffers.filter(offer => {
  if (offer.applies_to === 'all') {
    return true;
  } else if (offer.applies_to === 'categories' && product.category_id) {
    return offer.applies_to_ids.includes(product.category_id);
  } else if (offer.applies_to === 'products') {
    // Check if any variant SKU matches the offer SKUs
    const offerSkus = offer.applies_to_ids.map(sku => sku.trim()); // Trim spaces
    return productVariants.some(variant => 
      variant.sku && offerSkus.includes(variant.sku.trim())
    );
  }
  return false;
});

console.log('Applicable offers:', applicableOffers);

// Get the best offer (highest discount)
const bestOffer = applicableOffers.length > 0 ? 
  applicableOffers.reduce((best, current) => {
    const bestDiscount = best.discount_type === 'percentage' ? best.discount_value : (best.discount_value * 100 / (product.price_cents / 100));
    const currentDiscount = current.discount_type === 'percentage' ? current.discount_value : (current.discount_value * 100 / (product.price_cents / 100));
    return currentDiscount > bestDiscount ? current : best;
  }) : null;

// Calculate discounted price
let originalPrice = product.price_cents || 0;
let discountedPrice = originalPrice;
let discountPercentage = 0;

if (bestOffer) {
  if (bestOffer.discount_type === 'percentage') {
    discountedPrice = Math.round(originalPrice * (1 - bestOffer.discount_value / 100));
    discountPercentage = bestOffer.discount_value;
  } else if (bestOffer.discount_type === 'fixed') {
    discountedPrice = Math.max(0, originalPrice - bestOffer.discount_value * 100);
    discountPercentage = Math.round(((originalPrice - discountedPrice) / originalPrice) * 100);
  }
}

// SEO data extraction
const productName = product.name || product.title || 'Product';
const productDescription = product.description || `Discover ${productName} at Ethnic Treasures. Premium handcrafted ethnic wear with traditional craftsmanship.`;
const productPrice = product.price_cents ? (product.price_cents / 100).toFixed(2) : '0.00';
const productCurrency = product.currency || 'USD';
const productImage = product.image_url || product.image || '/images/og-default.jpg';
const productSlug = product.slug || product.id || product.uuid_id || id;
const productCategory = product.category || 'Ethnic Wear';
const productAvailability = product.stock_status === 'in_stock' ? 'InStock' : 'OutOfStock';

// Generate structured data
const productSchema = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": productName,
  "description": productDescription,
  "image": productImage.startsWith('http') ? productImage : new URL(productImage, Astro.url.origin).href,
  "brand": {
    "@type": "Brand",
    "name": "Ethnic Treasures"
  },
  "category": productCategory,
  "offers": {
    "@type": "Offer",
    "url": new URL(Astro.url.pathname, Astro.url.origin).href,
    "priceCurrency": productCurrency,
    "price": productPrice,
    "availability": `https://schema.org/${productAvailability}`,
    "seller": {
      "@type": "Organization",
      "name": "Ethnic Treasures"
    }
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.5",
    "reviewCount": "12",
    "bestRating": "5",
    "worstRating": "1"
  }
};

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": new URL('/', Astro.url.origin).href
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Shop",
      "item": new URL('/shop', Astro.url.origin).href
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": productName,
      "item": new URL(Astro.url.pathname, Astro.url.origin).href
    }
  ]
};

// Combine structured data
const structuredData = [productSchema, breadcrumbSchema];
---

<Layout 
  title={`${productName} - Ethnic Treasures`} 
  description={productDescription}
  keywords={`${productName}, ${productCategory}, ethnic wear, traditional clothing, handcrafted, ${product.keywords || ''}`}
  ogImage={productImage}
  ogType="product"
  structuredData={structuredData}
>
  <Header />
  
  <main class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-dark/60 mb-8">
      <a href="/" class="hover:text-gold transition-colors duration-300">Home</a>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
      <a href="/shop" class="hover:text-gold transition-colors duration-300">Shop</a>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
      <span class="text-dark font-medium">{product.name || product.title}</span>
    </nav>

    <!-- Product Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-16">
      <!-- Product Gallery -->
      <div>
        <div class="relative max-w-md mx-auto">
          <!-- Main Image with Zoom -->
          <div 
            id="image-container"
            class="relative overflow-hidden rounded-lg border border-gray-200"
            style="height: 400px;"
          >
            <img 
              id="main-image"
              src={(product.images && product.images.length > 0) ? product.images[0].url : (product.image_url || product.image || '/images/placeholder.jpg')} 
              alt={product.name || product.title}
              class="w-full h-full object-contain cursor-crosshair"
              loading="lazy"
            />
            
            <!-- Zoom Lens (Desktop only) -->
            <div 
              id="zoom-lens"
              class="absolute w-24 h-24 border-2 border-gold bg-white/20 pointer-events-none opacity-0 transition-opacity duration-200 hidden lg:block"
              style="display: none;"
            ></div>
          </div>
          
          <!-- Zoom Result (Desktop only) -->
          <div 
            id="zoom-result"
            class="absolute top-0 left-full w-96 h-96 border-2 border-gray-300 rounded-lg shadow-2xl overflow-hidden pointer-events-none opacity-0 transition-opacity duration-200 z-50 hidden lg:block"
            style="display: none; margin-left: 20px;"
          >
            <img 
              id="zoom-image"
              src={(product.images && product.images.length > 0) ? product.images[0].url : (product.image_url || product.image || '/images/placeholder.jpg')}
              alt={product.name || product.title}
              class="w-full h-full object-cover"
            />
          </div>

          <!-- Mobile/Tablet Touch Instructions -->
          <div class="mt-4 text-center text-sm text-dark/60 lg:hidden">
            <p>Tap image to zoom in â€¢ Pinch to zoom â€¢ Double tap to reset</p>
          </div>

          <!-- Thumbnail Gallery -->
          {product.images && product.images.length > 1 && (
            <div class="mt-6 grid grid-cols-4 gap-2">
              {product.images.map((image, index) => (
                <button
                  type="button"
                  class={`thumbnail-btn relative overflow-hidden rounded border-2 transition-all duration-200 ${
                    index === 0 ? 'border-gold' : 'border-gray-200 hover:border-gold/60'
                  }`}
                  onclick={`switchMainImage('${image.url}', ${index})`}
                  data-image-index={index}
                >
                  <img 
                    src={image.url} 
                    alt={`${product.name || product.title} - Image ${index + 1}`}
                    class="w-full h-20 object-cover"
                    loading="lazy"
                  />
                </button>
              ))}
            </div>
          )}
          {(!product.images || product.images.length <= 1) && (
            <div class="mt-6 text-sm text-gray-500">
              No additional images available
            </div>
          )}
        </div>
      </div>

      <!-- Product Information -->
      <div>
        <div class="space-y-6">
          <!-- Product Title -->
          <h1 class="text-3xl font-playfair font-bold text-dark">
            {product.name || product.title}
          </h1>

          <!-- Price -->
          <div class="space-y-2">
            {bestOffer ? (
              <div class="flex items-center space-x-3">
                <span class="text-2xl font-bold text-gold">
                  {(discountedPrice / 100).toFixed(2)} {product.currency || 'USD'}
                </span>
                <span class="text-lg text-gray-500 line-through">
                  {(originalPrice / 100).toFixed(2)} {product.currency || 'USD'}
                </span>
                <span class="bg-red-500 text-white px-2 py-1 rounded-full text-sm font-bold">
                  -{discountPercentage}%
                </span>
              </div>
            ) : (
              <div class="text-2xl font-bold text-gold">
                {product.price_cents ? (product.price_cents / 100).toFixed(2) : 'Price not available'} {product.currency || 'USD'}
              </div>
            )}
            {bestOffer && (
              <div class="text-sm text-green-600 font-medium">
                ðŸŽ‰ You save {((originalPrice - discountedPrice) / 100).toFixed(2)} {product.currency || 'USD'}!
              </div>
            )}
          </div>

          <!-- Description -->
          <p class="text-dark/70 leading-relaxed">
            {product.description || 'Product description not available.'}
          </p>

          <!-- Action Buttons -->
          <div class="flex space-x-4">
            <!-- Add to Cart Button -->
            <button 
              id="add-to-cart-btn"
              class="flex-1 bg-maroon text-cream py-3 px-6 rounded-md hover:bg-maroon/90 transition-colors font-medium"
              onclick="handleAddToCart()"
            >
              Add to Cart
            </button>
            
            <!-- Wishlist Button -->
            <button 
              id="wishlist-btn"
              class="bg-white border-2 border-gold text-gold py-3 px-4 rounded-md hover:bg-gold hover:text-cream transition-colors"
              onclick="handleToggleWishlist()"
              title="Add to Wishlist"
            >
              <svg 
                id="wishlist-icon"
                class="w-6 h-6 transition-colors duration-200" 
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
              >
                <path 
                  stroke-linecap="round" 
                  stroke-linejoin="round" 
                  stroke-width="2" 
                  d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Tabs -->
    <section class="mb-16">
      <div class="border-b border-gold/20">
        <nav class="flex space-x-8">
          <button 
            x-data="{ active: true }"
            @click="active = true; $el.classList.add('border-gold', 'text-gold'); $el.classList.remove('border-transparent', 'text-dark/60'); $el.parentElement.querySelectorAll('button').forEach(btn => { if (btn !== $el) btn.classList.remove('border-gold', 'text-gold'); btn.classList.add('border-transparent', 'text-dark/60'); })"
            class="py-4 px-1 border-b-2 border-gold text-gold font-semibold tab-button"
            data-tab="details"
          >
            Details
          </button>
          <button 
            @click="$el.classList.add('border-gold', 'text-gold'); $el.classList.remove('border-transparent', 'text-dark/60'); $el.parentElement.querySelectorAll('button').forEach(btn => { if (btn !== $el) btn.classList.remove('border-gold', 'text-gold'); btn.classList.add('border-transparent', 'text-dark/60'); })"
            class="py-4 px-1 border-b-2 border-transparent text-dark/60 hover:text-gold transition-colors duration-300 tab-button"
            data-tab="fabric"
          >
            Fabric & Care
          </button>
          <button 
            @click="$el.classList.add('border-gold', 'text-gold'); $el.classList.remove('border-transparent', 'text-dark/60'); $el.parentElement.querySelectorAll('button').forEach(btn => { if (btn !== $el) btn.classList.remove('border-gold', 'text-gold'); btn.classList.add('border-transparent', 'text-dark/60'); })"
            class="py-4 px-1 border-b-2 border-transparent text-dark/60 hover:text-gold transition-colors duration-300 tab-button"
            data-tab="shipping"
          >
            Shipping
          </button>
          <button 
            @click="$el.classList.add('border-gold', 'text-gold'); $el.classList.remove('border-transparent', 'text-dark/60'); $el.parentElement.querySelectorAll('button').forEach(btn => { if (btn !== $el) btn.classList.remove('border-gold', 'text-gold'); btn.classList.add('border-transparent', 'text-dark/60'); })"
            class="py-4 px-1 border-b-2 border-transparent text-dark/60 hover:text-gold transition-colors duration-300 tab-button"
            data-tab="reviews"
          >
            Reviews
          </button>
        </nav>
      </div>

      <!-- Tab Content -->
      <div class="py-8">
        <!-- Details Tab -->
        <div id="details-content" class="tab-content space-y-6">
          <div>
            <h3 class="font-playfair text-2xl font-semibold text-maroon mb-4">Product Details</h3>
            <div class="prose prose-lg text-dark/90 max-w-none">
              <p>{product.description || 'Detailed product information will be displayed here.'}</p>
            </div>
          </div>
        </div>

        <!-- Fabric & Care Tab -->
        <div id="fabric-content" class="tab-content space-y-6 hidden">
          <div>
            <h3 class="font-playfair text-2xl font-semibold text-maroon mb-4">Fabric & Care Instructions</h3>
            <div class="space-y-4">
              <div>
                <h4 class="font-semibold text-lg mb-2">Fabric Composition</h4>
                <p class="text-dark/70">Premium quality fabric with traditional craftsmanship. Each piece is carefully selected for its superior quality and durability.</p>
              </div>
              <div>
                <h4 class="font-semibold text-lg mb-2">Care Instructions</h4>
                <ul class="list-disc list-inside text-dark/70 space-y-1">
                  <li>Dry clean recommended for best results</li>
                  <li>Hand wash in cold water with mild detergent</li>
                  <li>Do not bleach or use harsh chemicals</li>
                  <li>Iron on low heat if needed</li>
                  <li>Store in a cool, dry place</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Shipping Tab -->
        <div id="shipping-content" class="tab-content space-y-6 hidden">
          <div>
            <h3 class="font-playfair text-2xl font-semibold text-maroon mb-4">Shipping & Delivery</h3>
            <div class="space-y-4">
              <div>
                <h4 class="font-semibold text-lg mb-2">Shipping Options</h4>
                <ul class="list-disc list-inside text-dark/70 space-y-1">
                  <li>Standard Shipping: 5-7 business days</li>
                  <li>Express Shipping: 2-3 business days</li>
                  <li>International Shipping: 10-15 business days</li>
                </ul>
              </div>
              <div>
                <h4 class="font-semibold text-lg mb-2">Shipping Costs</h4>
                <p class="text-dark/70">Free shipping on orders above â‚¹2000. Standard shipping charges apply for orders below this amount.</p>
              </div>
              <div>
                <h4 class="font-semibold text-lg mb-2">Packaging</h4>
                <p class="text-dark/70">All items are carefully packaged with premium materials to ensure safe delivery.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Reviews Tab -->
        <div id="reviews-content" class="tab-content space-y-6 hidden">
          <div>
            <h3 class="font-playfair text-2xl font-semibold text-maroon mb-4">Customer Reviews</h3>
            <div class="space-y-6">
              <div class="border-b pb-4">
                <div class="flex items-center mb-2">
                  <div class="flex text-gold">
                    â˜…â˜…â˜…â˜…â˜…
                  </div>
                  <span class="ml-2 font-semibold">Sarah M.</span>
                </div>
                <p class="text-dark/70">Absolutely beautiful piece! The quality exceeded my expectations and the craftsmanship is outstanding.</p>
              </div>
              <div class="border-b pb-4">
                <div class="flex items-center mb-2">
                  <div class="flex text-gold">
                    â˜…â˜…â˜…â˜…â˜†
                  </div>
                  <span class="ml-2 font-semibold">Priya R.</span>
                </div>
                <p class="text-dark/70">Lovely product with excellent quality. Fast shipping and great customer service.</p>
              </div>
              <div class="text-center">
                <button class="bg-maroon text-cream px-6 py-2 rounded-md hover:bg-maroon/90 transition-colors">
                  Write a Review
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ bestOffer, discountedPrice, originalPrice }}>
  // Pass discount data from server to client
  const discountData = {
    hasDiscount: !!bestOffer,
    discountedPrice: discountedPrice / 100,
    originalPrice: originalPrice / 100
  };
  
  window.hasDiscount = discountData.hasDiscount ? 'true' : 'false';
  window.discountedPrice = discountData.discountedPrice.toString();
  window.originalPrice = discountData.originalPrice.toString();
</script>

<script>
  // Import API functions
  import { addToCart, toggleWishlist, getWishlist } from '../../lib/api.js';
  import '../../lib/toast.js';

  // Wishlist state
  let isWishlisted = false;
  let currentProductId = null;

  document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    // Image switching function
    window.switchMainImage = function(imageUrl, index) {
      const mainImage = document.getElementById('main-image');
      const zoomImage = document.getElementById('zoom-image');
      
      if (mainImage) {
        mainImage.src = imageUrl;
      }
      if (zoomImage) {
        zoomImage.src = imageUrl;
      }
      
      // Update thumbnail active states
      const thumbnailBtns = document.querySelectorAll('.thumbnail-btn');
      thumbnailBtns.forEach((btn, i) => {
        if (i === index) {
          btn.classList.remove('border-gray-200');
          btn.classList.add('border-gold');
        } else {
          btn.classList.remove('border-gold');
          btn.classList.add('border-gray-200');
        }
      });
    };

    // Tab functionality
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.getAttribute('data-tab');
        
        // Hide all tab contents
        tabContents.forEach(content => {
          content.classList.add('hidden');
        });
        
        // Show selected tab content
        const selectedContent = document.getElementById(`${tabName}-content`);
        if (selectedContent) {
          selectedContent.classList.remove('hidden');
        }
        
        // Update button styles
        tabButtons.forEach(btn => {
          btn.classList.remove('border-gold', 'text-gold');
          btn.classList.add('border-transparent', 'text-dark/60');
        });
        button.classList.remove('border-transparent', 'text-dark/60');
        button.classList.add('border-gold', 'text-gold');
      });
    });

    // Image zoom functionality
    const imageContainer = document.getElementById('image-container');
    const mainImage = document.getElementById('main-image');
    const zoomLens = document.getElementById('zoom-lens');
    const zoomResult = document.getElementById('zoom-result');
    const zoomImage = document.getElementById('zoom-image');

    // Check if device is mobile/tablet
    const isMobileOrTablet = window.innerWidth < 1024;

    if (imageContainer && mainImage) {
      let isZoomActive = false;
      let currentScale = 1;
      let startX = 0;
      let lastTouchEnd = 0;

      // Desktop zoom functionality
      if (!isMobileOrTablet && zoomLens && zoomResult && zoomImage) {
        
        imageContainer.addEventListener('mouseenter', function() {
          zoomLens.style.display = 'block';
          zoomResult.style.display = 'block';
          setTimeout(() => {
            zoomLens.classList.remove('opacity-0');
            zoomResult.classList.remove('opacity-0');
          }, 10);
          isZoomActive = true;
        });

        imageContainer.addEventListener('mouseleave', function() {
          zoomLens.classList.add('opacity-0');
          zoomResult.classList.add('opacity-0');
          setTimeout(() => {
            zoomLens.style.display = 'none';
            zoomResult.style.display = 'none';
          }, 200);
          isZoomActive = false;
        });

        imageContainer.addEventListener('mousemove', function(e) {
          if (!isZoomActive) return;

          const rect = imageContainer.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // Calculate lens position
          const lensWidth = zoomLens.offsetWidth;
          const lensHeight = zoomLens.offsetHeight;
          let lensX = x - lensWidth / 2;
          let lensY = y - lensHeight / 2;

          // Keep lens within container bounds
          if (lensX < 0) lensX = 0;
          if (lensY < 0) lensY = 0;
          if (lensX + lensWidth > rect.width) lensX = rect.width - lensWidth;
          if (lensY + lensHeight > rect.height) lensY = rect.height - lensHeight;

          // Position lens
          zoomLens.style.left = lensX + 'px';
          zoomLens.style.top = lensY + 'px';

          // Calculate zoom
          const zoomFactor = 3;
          const zoomX = (lensX / rect.width) * 100;
          const zoomY = (lensY / rect.height) * 100;

          // Apply zoom to result image
          zoomImage.style.transform = `scale(${zoomFactor})`;
          zoomImage.style.transformOrigin = `${zoomX}% ${zoomY}%`;
        });
      }

      // Add to Cart functionality
      window.handleAddToCart = async function() {
        const button = document.getElementById('add-to-cart-btn');
        if (!button) {
          return;
        }
        
        // Get product slug from URL
        const urlPath = window.location.pathname;
        const pathParts = urlPath.split('/');
        const productSlug = pathParts[pathParts.length - 1];
                
        if (!productSlug || productSlug.trim() === '' || productSlug === 'undefined') {
                    return;
        }

        // Show loading state
        const originalText = button.textContent;
        button.textContent = 'Adding...';
        button.disabled = true;

        try {
          // First, fetch product data to get the UUID
          const API_URL = 'https://etreasure-1.onrender.com';
          const productResponse = await fetch(`${API_URL}/api/products/${productSlug}`);
          
          if (!productResponse.ok) {
            throw new Error(`Failed to fetch product data. Status: ${productResponse.status}`);
          }
          
          const productData = await productResponse.json();
          const productUuid = productData.id;
                    
          if (!productUuid) {
            throw new Error('Product UUID not found in API response');
          }
          
          // Send discounted price if available
          const priceToSend = window.hasDiscount === 'true' ? parseFloat(window.discountedPrice) : null;
          await addToCart(productUuid, 1, priceToSend);
          
          // Show success state
          button.textContent = 'Added to Cart!';
          button.classList.add('bg-green-600');
          button.classList.remove('bg-maroon');
          
          // Show success toast
          showSuccess('Product added to cart successfully!');
          
          // Reset button after 2 seconds
          setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-600');
            button.classList.add('bg-maroon');
            button.disabled = false;
          }, 2000);

          // Dispatch cart update event
          window.dispatchEvent(new CustomEvent('cart-updated'));
          
        } catch (error) {
          showError('Failed to add product to cart. Please try again.');
          
          // Reset button state
          button.textContent = originalText;
          button.disabled = false;
        }
      };

      // Wishlist functionality
      window.handleToggleWishlist = async function() {
        const button = document.getElementById('wishlist-btn');
        const icon = document.getElementById('wishlist-icon');
        
        if (!button || !icon) {
          return;
        }
        
        // Get product slug from URL
        const urlPath = window.location.pathname;
        const pathParts = urlPath.split('/');
        const productSlug = pathParts[pathParts.length - 1];
                
        if (!productSlug || productSlug.trim() === '' || productSlug === 'undefined') {
                    return;
        }

        // Show loading state
        button.disabled = true;
        const originalClasses = button.className;
        button.classList.add('opacity-50', 'cursor-not-allowed');

        try {
          // First, fetch product data to get the UUID
          const API_URL = 'https://etreasure-1.onrender.com';
          const productResponse = await fetch(`${API_URL}/api/products/${productSlug}`);
          
          if (!productResponse.ok) {
            throw new Error(`Failed to fetch product data. Status: ${productResponse.status}`);
          }
          
          const productData = await productResponse.json();
          const productUuid = productData.id;
                    
          if (!productUuid) {
            throw new Error('Product UUID not found in API response');
          }
          
          // Store current product ID for future use
          currentProductId = productUuid;
          
          // Use the proper toggleWishlist API function with session management
          // Send discounted price if available
          const priceToSend = window.hasDiscount === 'true' ? parseFloat(window.discountedPrice) : null;
          const data = await toggleWishlist(productUuid, priceToSend);
          
          // Update wishlist state based on response
          isWishlisted = data.in_wishlist;
          
          // Update icon appearance
          if (isWishlisted) {
            icon.classList.add('fill-red-500', 'text-red-500');
            icon.classList.remove('text-gold');
            button.classList.add('bg-red-500', 'text-white', 'border-red-500');
            button.classList.remove('bg-white', 'border-gold', 'text-gold');
            showSuccess('Product added to wishlist!');
          } else {
            icon.classList.remove('fill-red-500', 'text-red-500');
            icon.classList.add('text-gold');
            button.classList.remove('bg-red-500', 'text-white', 'border-red-500');
            button.classList.add('bg-white', 'border-gold', 'text-gold');
            showSuccess('Product removed from wishlist!');
          }
          
          // Dispatch wishlist update event
          window.dispatchEvent(new CustomEvent('wishlist-updated'));
          
        } catch (error) {
          showError('Failed to update wishlist. Please try again.');
        } finally {
          // Reset button state
          button.disabled = false;
          button.className = originalClasses;
        }
      };

      // Initialize wishlist state on page load
      async function initializeWishlistState() {
        try {
          const urlPath = window.location.pathname;
          const pathParts = urlPath.split('/');
          const productSlug = pathParts[pathParts.length - 1];
          
          if (!productSlug || productSlug.trim() === '' || productSlug === 'undefined') {
            return;
          }

          const API_URL = 'https://etreasure-1.onrender.com';
          const productResponse = await fetch(`${API_URL}/api/products/${productSlug}`);
          
          if (!productResponse.ok) {
            return;
          }
          
          const productData = await productResponse.json();
          const productUuid = productData.id;
          
          if (!productUuid) {
            return;
          }
          
          currentProductId = productUuid;
          
          // Use the proper getWishlist API function with session management
          const wishlistData = await getWishlist();
          
          if (wishlistData.items && Array.isArray(wishlistData.items)) {
            isWishlisted = wishlistData.items.some(item => item.product_id === productUuid);
            
            // Update initial button state
            const button = document.getElementById('wishlist-btn');
            const icon = document.getElementById('wishlist-icon');
            
            if (button && icon && isWishlisted) {
              icon.classList.add('fill-red-500', 'text-red-500');
              icon.classList.remove('text-gold');
              button.classList.add('bg-red-500', 'text-white', 'border-red-500');
              button.classList.remove('bg-white', 'border-gold', 'text-gold');
            }
          }
        } catch (error) {
          // Silently handle initialization errors
        }
      }

      // Initialize wishlist state
      initializeWishlistState();

      // Mobile/Tablet touch functionality
      if (isMobileOrTablet) {
        // Single tap to zoom
        imageContainer.addEventListener('touchstart', function(e) {
          if (e.touches.length === 1) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            lastTouchEnd = Date.now();
          }
        });

        imageContainer.addEventListener('touchend', function(e) {
          if (e.touches.length === 0) {
            const currentTime = Date.now();
            const tapLength = currentTime - lastTouchEnd;
            
            // Check for double tap
            if (tapLength < 300 && tapLength > 0) {
              e.preventDefault();
              if (currentScale === 1) {
                // Zoom in
                currentScale = 2;
                mainImage.style.transform = `scale(${currentScale})`;
                mainImage.style.transition = 'transform 0.3s ease';
              } else {
                // Reset zoom
                currentScale = 1;
                mainImage.style.transform = `scale(${currentScale})`;
                mainImage.style.transition = 'transform 0.3s ease';
              }
            }
          }
        });

        // Pinch to zoom
        let initialDistance = 0;
        
        imageContainer.addEventListener('touchstart', function(e) {
          if (e.touches.length === 2) {
            initialDistance = Math.hypot(
              e.touches[0].clientX - e.touches[1].clientX,
              e.touches[0].clientY - e.touches[1].clientY
            );
          }
        });

        imageContainer.addEventListener('touchmove', function(e) {
          if (e.touches.length === 2) {
            e.preventDefault();
            const currentDistance = Math.hypot(
              e.touches[0].clientX - e.touches[1].clientX,
              e.touches[0].clientY - e.touches[1].clientY
            );
            
            const scale = currentDistance / initialDistance;
            currentScale = Math.min(Math.max(1, scale), 3); // Limit between 1x and 3x
            
            mainImage.style.transform = `scale(${currentScale})`;
            mainImage.style.transition = 'none';
          }
        });

        // Pan when zoomed
        let isPanning = false;
        let panStartX = 0;
        let panStartY = 0;
        let translateX = 0;
        let translateY = 0;

        imageContainer.addEventListener('touchstart', function(e) {
          if (e.touches.length === 1 && currentScale > 1) {
            isPanning = true;
            panStartX = e.touches[0].clientX - translateX;
            panStartY = e.touches[0].clientY - translateY;
          }
        });

        imageContainer.addEventListener('touchmove', function(e) {
          if (isPanning && e.touches.length === 1) {
            e.preventDefault();
            translateX = e.touches[0].clientX - panStartX;
            translateY = e.touches[0].clientY - panStartY;
            
            // Limit panning to image bounds
            const maxTranslate = (currentScale - 1) * 100;
            translateX = Math.max(-maxTranslate, Math.min(maxTranslate, translateX));
            translateY = Math.max(-maxTranslate, Math.min(maxTranslate, translateY));
            
            mainImage.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
          }
        });

        imageContainer.addEventListener('touchend', function() {
          isPanning = false;
        });
      }
    }
  });
</script>

</main>

<Footer />
</Layout>