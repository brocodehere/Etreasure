import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ProductGallery from '../../components/product/ProductGallery';
import ProductDetails from '../../components/product/ProductDetails';
import AddToCartButton from '../../components/product/AddToCartButton';
import RelatedProducts from '../../components/product/RelatedProducts';

const { id } = Astro.params; // slug

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8080';

const fields = [
  'id',
  'slug',
  'title',
  'description',
  'price_cents',
  'currency',
  'availability',
  'hero_image'
].join(',');

const productRes = await fetch(`${API_URL}/api/products/${id}?fields=${fields}`);
if (!productRes.ok) {
  throw new Error('Product not found');
}

const product = await productRes.json();

const relatedRes = await fetch(`${API_URL}/api/products/${id}/related`);
const relatedData = relatedRes.ok ? await relatedRes.json() : { items: [] };
const relatedItems = relatedData.items ?? [];

const heroUrl = product.hero_image?.url ?? '/images/categories/baby.webp';

const price = (product.price_cents / 100).toFixed(2);

const productJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: product.title,
  description: product.description,
  image: heroUrl,
  sku: product.slug,
  offers: {
    '@type': 'Offer',
    priceCurrency: product.currency,
    price,
    availability:
      product.availability === 'InStock'
        ? 'https://schema.org/InStock'
        : 'https://schema.org/OutOfStock',
  },
};

const breadcrumbJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: 'https://etreasure.com/',
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Shop',
      item: 'https://etreasure.com/shop',
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: product.title,
      item: `https://etreasure.com/product/${product.slug}`,
    },
  ],
};
---

<Layout title={`${product.title} - Ethnic Treasures`} description={product.description}>
  <Fragment slot="head">
    <link rel="preload" as="image" href={heroUrl} />
    <script type="application/ld+json">
      {JSON.stringify(productJsonLd)}
    </script>
    <script type="application/ld+json">
      {JSON.stringify(breadcrumbJsonLd)}
    </script>
    <meta property="og:title" content={`${product.title} - Ethnic Treasures`} />
    <meta property="og:description" content={product.description} />
    <meta property="og:image" content={heroUrl} />
    <meta property="og:type" content="product" />
  </Fragment>
  {
    id: 1,
    name: "Premium Leather Handbag",
    category: "hand-bags",
    price: 2999,
    image: "/images/categories/baby.webp",
    description: "Genuine leather handbag with elegant design",
    rating: 4.5,
    reviews: 128
  },
  {
    id: 2,
    name: "Classic Tote Bag",
    category: "tote-bags",
    price: 1499,
    image: "/images/categories/baby.webp",
    description: "Spacious tote bag for everyday use",
    rating: 4.3,
    reviews: 89
  },
  {
    id: 3,
    name: "Professional Laptop Bag",
    category: "laptop-bags",
    price: 3499,
    image: "/images/categories/baby.webp",
    description: "Padded laptop bag with multiple compartments",
    rating: 4.7,
    reviews: 156
  },
  {
    id: 4,
    name: "Embroidered Evening Clutch",
    category: "embroidered-clutches",
    price: 1999,
    image: "/images/categories/baby.webp",
    description: "Beautiful embroidered clutch for special occasions",
    rating: 4.6,
    reviews: 92
  },
  {
    id: 5,
    name: "Handmade Crochet Throw",
    category: "crochet-throws",
    price: 2499,
    image: "/images/categories/baby.webp",
    description: "Soft crochet throw blanket for home decor",
    rating: 4.4,
    reviews: 67
  },
  {
    id: 6,
    name: "Baby Safety Throw",
    category: "baby-throw",
    price: 1299,
    image: "/images/categories/baby.webp",
    description: "Ultra-soft throw blanket for babies",
    rating: 4.8,
    reviews: 203
  },
  {
    id: 7,
    name: "Everyday Canvas Bag",
    category: "everyday-bags",
    price: 999,
    image: "/images/categories/baby.webp",
    description: "Durable canvas bag for daily activities",
    rating: 4.2,
    reviews: 145
  },
  {
    id: 8,
    name: "Designer Handbag",
    category: "hand-bags",
    price: 4999,
    image: "/images/categories/baby.webp",
    description: "Designer handbag with premium finish",
    rating: 4.9,
    reviews: 78
  },
  {
    id: 9,
    name: "Large Shopping Tote",
    category: "tote-bags",
    price: 1799,
    image: "/images/categories/baby.webp",
    description: "Large tote bag for shopping and travel",
    rating: 4.1,
    reviews: 134
  }
];

// Generate suggestions (70% from same category, 30% from other categories)
function generateSuggestions(currentProduct, allProducts) {
  // Filter out current product
  const otherProducts = allProducts.filter(p => p.id !== currentProduct.id);
  
  // Products from same category
  const sameCategoryProducts = otherProducts.filter(p => p.category === currentProduct.category);
  
  // Products from different categories
  const differentCategoryProducts = otherProducts.filter(p => p.category !== currentProduct.category);
  
  // Calculate how many from each category (70% and 30% of 6 products)
  const totalSuggestions = 6;
  const sameCategoryCount = Math.floor(totalSuggestions * 0.7); // 4 products
  const differentCategoryCount = totalSuggestions - sameCategoryCount; // 2 products
  
  // Randomly select products
  const shuffledSameCategory = [...sameCategoryProducts].sort(() => 0.5 - Math.random());
  const shuffledDifferentCategory = [...differentCategoryProducts].sort(() => 0.5 - Math.random());
  
  const suggestions = [
    ...shuffledSameCategory.slice(0, sameCategoryCount),
    ...shuffledDifferentCategory.slice(0, differentCategoryCount)
  ];
  
  // If we don't have enough products, fill with whatever is available
  if (suggestions.length < totalSuggestions) {
    const remainingProducts = otherProducts.filter(p => !suggestions.includes(p));
    suggestions.push(...remainingProducts.slice(0, totalSuggestions - suggestions.length));
  }
  
  return suggestions.slice(0, totalSuggestions);
}

const suggestedProducts = generateSuggestions(product, allProducts);

// Function to render star rating
function renderStars(rating) {
  const fullStars = Math.floor(rating);
  const hasHalfStar = rating % 1 !== 0;
  const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
  
  let stars = '';
  
  // Full stars
  for (let i = 0; i < fullStars; i++) {
    stars += '<span class="text-gold">★</span>';
  }
  
  // Half star
  if (hasHalfStar) {
    stars += '<span class="text-gold">☆</span>';
  }
  
  // Empty stars
  for (let i = 0; i < emptyStars; i++) {
    stars += '<span class="text-gray-300">★</span>';
  }
  
  return stars;
}
---

<Layout title={`${product.name} - Ethnic Treasures`} description={product.description}>
	<Header />
	
	<!-- Breadcrumb -->
	<section class="py-4 bg-cream">
		<div class="container mx-auto px-4">
			<nav class="flex items-center space-x-2 text-sm">
				<a href="/" class="text-dark/70 hover:text-maroon transition-colors">Home</a>
				<span class="text-dark/50">/</span>
				<a href="/shop" class="text-dark/70 hover:text-maroon transition-colors">Shop</a>
				<span class="text-dark/50">/</span>
				<a href={`/shop/${product.category}`} class="text-dark/70 hover:text-maroon transition-colors capitalize">
					{product.category.replace('-', ' ')}
				</a>
				<span class="text-dark/50">/</span>
				<span class="text-dark font-medium">{product.title}</span>
			</nav>
		</div>
	</section>

	<!-- Product Section -->
	<section class="py-12 bg-white">
		<div class="container mx-auto px-4">
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
				<!-- Product Gallery -->
				<div>
					<ProductGallery client:load hero={{ url: heroUrl, alt: product.title }} />
				</div>

				<!-- Product Information -->
				<div>
					<ProductDetails client:load product={product} />
					<AddToCartButton client:load product={product} />
				</div>
			</div>
		</div>
	</section>

	<!-- Related Products -->
	{relatedItems.length > 0 && (
		<section class="py-16 bg-cream">
			<div class="container mx-auto px-4">
				<h2 class="text-3xl font-bold text-center mb-12 text-dark">Related Products</h2>
				<RelatedProducts client:load products={relatedItems} />
			</div>
		</section>
	)}

	<Footer />
</Layout>
