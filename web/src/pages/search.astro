---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

// Get search query from URL
const url = new URL(Astro.request.url);
const q = url.searchParams.get('q') || '';
let results = [];
let took = 0;

// R2 base URL for images
const R2_BASE_URL = 'https://pub-1a3924a6c6994107be6fe9f3ed794c0a.r2.dev';

// Helper function to build full image URLs
const getImageUrl = (imagePath: string) => {
  if (!imagePath) return '';
  if (imagePath.startsWith('http')) return imagePath;
  // Use R2 base URL directly like shop page products API
  return `https://pub-1a3924a6c6994107be6fe9f3ed794c0a.r2.dev/${imagePath}`;
};

// Fetch search results from API
if (q && q.length >= 1) {
  const apiUrl = `https://etreasure-1.onrender.com/api/search?q=${encodeURIComponent(q)}&limit=20`;
  try {
    const start = Date.now();
    const res = await fetch(apiUrl);
    const json = await res.json();
    results = json.results || [];
    took = Date.now() - start;
  } catch (e) {
    results = [];
  }
}

// Format price in INR
const formatPrice = (price: number) => {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    minimumFractionDigits: 0,
  }).format(price);
};
---

<Layout title={q ? `Search Results for "${q}"` : 'Search Products'} description={q ? `Search results for "${q}" in Ethnic Treasures collection` : 'Search our collection of handcrafted treasures'}>
  <Header />
  
  <main class="container mx-auto px-4 py-12">
    <!-- Search Header -->
    <div class="mb-12">
      {q ? (
        <>
          <h1 class="text-4xl font-playfair font-bold text-dark mb-2">
            Search Results for "<span class="text-gold">{q}</span>"
          </h1>
          <p class="text-dark/60">
            {results.length === 0
              ? 'No products found - showing suggested products'
              : `${results.length} product${results.length !== 1 ? 's' : ''} found`}
          </p>
          <p class="text-sm text-dark/40">Search took {took}ms</p>
        </>
      ) : (
        <h1 class="text-4xl font-playfair font-bold text-dark">Search Products</h1>
      )}
    </div>

    {!q && (
      <div class="bg-maroon/10 border border-maroon/20 rounded-lg p-8 text-center">
        <svg class="w-16 h-16 mx-auto text-maroon/50 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width={1.5} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <p class="text-dark/60 text-lg mb-2">Use the search bar in the header to find products.</p>
        <p class="text-dark/40">Search for bags, throws, crafts, and more!</p>
      </div>
    )}

    {q && (
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {results.length === 0 ? (
          <div class="col-span-full bg-gray-50 rounded-lg p-12 text-center">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width={1.5} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="text-lg font-semibold text-dark mb-2">No products found for "{q}"</h3>
            <p class="text-dark/60 mb-4">Try different keywords or browse our suggested products below.</p>
            <a href="/shop" class="inline-flex items-center gap-2 bg-gold text-maroon px-6 py-2 rounded-full font-semibold hover:bg-gold/90 transition-colors">
              Browse All Products
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
          </div>
        ) : (
          results.map((item) => (
            <a
              href={item.link || `/shop?category=${item.slug}`}
              class="group bg-white rounded-lg overflow-hidden border border-gold/10 hover:border-gold/30 transition-all hover:shadow-lg"
            >
              <!-- Image -->
              <div class="relative w-full aspect-square bg-gray-100 overflow-hidden">
                {item.image ? (
                  <img
                    src={getImageUrl(item.image)}
                    alt={item.title}
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                    loading="lazy"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center bg-gray-200">
                    <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                    </svg>
                  </div>
                )}
                
                {/* Suggested badge for fallback products */}
                {item.note === 'suggested' && (
                  <div class="absolute top-2 left-2 bg-gold text-maroon text-xs px-2 py-1 rounded-full font-medium">
                    Suggested
                  </div>
                )}
              </div>

              <!-- Content -->
              <div class="p-4">
                <h3 class="font-semibold text-dark text-sm mb-2 line-clamp-2 group-hover:text-gold transition-colors">
                  {item.title}
                </h3>

                {item.excerpt && (
                  <p class="text-xs text-dark/50 line-clamp-2 mb-3">{item.excerpt}</p>
                )}

                {item.price && (
                  <p class="text-lg font-bold text-gold">{formatPrice(item.price)}</p>
                )}

                {item.type && (
                  <p class="text-xs text-dark/40 mt-2 capitalize">{item.type}</p>
                )}
              </div>
            </a>
          ))
        )}
      </div>
    )}

    {q && results.length > 0 && (
      <div class="mt-12 text-center">
        <a href="/shop" class="inline-flex items-center gap-2 bg-maroon text-white px-6 py-3 rounded-full font-semibold hover:bg-gold hover:text-maroon transition-all">
          View All Products
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </a>
      </div>
    )}
  </main>

  <Footer />

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</Layout>
