---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { fetchSales, fetchProducts, fetchCategories } from '../lib/api';

// Fetch sales data from database
const salesResponse = await fetchSales();
const sales = salesResponse.items || [];

// Fetch all products and categories for sale details
const productsResponse = await fetchProducts({ limit: 100 });
const allProducts = productsResponse.items || [];

const categoriesResponse = await fetchCategories();
const allCategories = categoriesResponse.items || [];

// Filter and sort active sales
const activeSales = sales
  .filter(sale => sale.is_active && new Date(sale.ends_at) > new Date())
  .sort((a, b) => new Date(a.ends_at).getTime() - new Date(b.ends_at).getTime());

// Helper function to get products for a sale
async function getProductsForSale(sale) {
  if (sale.applies_to === 'all') {
    return allProducts;
  } else if (sale.applies_to === 'products') {
    // For product-specific sales, we need to fetch products that have variants matching the SKUs
    const saleSkus = sale.applies_to_ids.map(sku => sku.trim());
    const productsWithMatchingVariants = [];
    
    
    // Now we can use the public endpoint with variants field
    const productPromises = allProducts.map(async (product, index) => {
      try {
        // Fetch product details including variants using public endpoint
        // Use product.slug instead of product.id since PublicGet expects a slug
        const response = await fetch(`https://etreasure-1.onrender.com/api/products/${product.slug}?fields=variants`);
        
        if (response.ok) {
          const productData = await response.json();
          const variants = productData.variants || [];
          
          // Log variants for debugging
          if (variants.length > 0) {
            const variantSkus = variants.map(v => v.sku);
            
            // Check if any variant matches the sale SKUs
            const matchingVariant = variants.find(variant => 
              variant.sku && saleSkus.includes(variant.sku.trim())
            );
            
            if (matchingVariant) {
              return {
                ...product,
                variants: variants,
                // Add missing fields from response
                category_id: productData.category_id || product.category_id
              };
            }
          } else {
            console.log(`Product ${index}: ${product.title} has no variants`);
          }
        } else {
          console.log(`Product ${index}: Failed to fetch ${product.title}`);
        }
      } catch (error) {
        console.log(`Product ${index}: Error fetching ${product.title}: ${error.message}`);
      }
      return null;
    });
    
    // Wait for all promises to resolve
    const results = await Promise.all(productPromises);
    
    // Filter out null results and return matching products
    return results.filter(product => product !== null);
    
  } else if (sale.applies_to === 'categories') {
    return allProducts.filter(product => 
      product.category_id && sale.applies_to_ids.includes(product.category_id)
    );
  }
  return [];
}

// Pre-fetch products for all sales
const salesWithProducts = await Promise.all(
  activeSales.map(async (sale) => {
    const saleProducts = await getProductsForSale(sale);
    return {
      ...sale,
      products: saleProducts
    };
  })
);
function getDiscountedPrice(priceCents, discountType, discountValue) {
  if (discountType === 'percentage') {
    return Math.round(priceCents * (1 - discountValue / 100));
  } else if (discountType === 'fixed') {
    return Math.max(0, priceCents - discountValue * 100); // Convert to cents
  }
  return priceCents;
}

// Helper function to format price
function formatPrice(cents) {
  return (cents / 100).toFixed(2);
}
---

<Layout title="Special Sales - Ethnic Treasures" description="Discover amazing deals and discounts on authentic Indian handcrafted treasures. Limited time sales on traditional crafts and artisanal products.">
  <Header />
  
  <!-- Hero Section -->
  <section class="relative py-20 bg-gradient-to-br from-maroon via-maroon/80 to-maroon overflow-hidden">
    <!-- Background Effects -->
    <div class="absolute inset-0">
      <div class="absolute top-10 left-20 w-64 h-64 bg-gold/20 rounded-full blur-3xl animate-pulse"></div>
      <div class="absolute bottom-10 right-20 w-80 h-80 bg-white/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
    </div>
    
    <div class="container mx-auto px-4 relative z-10">
      <div class="text-center text-white">
        <h1 class="font-playfair text-4xl md:text-6xl font-bold mb-6 animate-fade-in">
          Special Sales
        </h1>
        <div class="w-32 h-1 bg-gold mx-auto mb-8 animate-gold-shine"></div>
        <p class="text-xl md:text-2xl max-w-4xl mx-auto leading-relaxed animate-fade-up" style="animation-delay: 0.3s">
          Discover amazing deals on authentic Indian handcrafted treasures
        </p>
        <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center items-center">
          <div class="bg-gold/20 backdrop-blur-sm px-6 py-3 rounded-full border border-gold/30">
            <svg class="w-6 h-6 text-gold mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm0 4a1 1 0 000 2h6a1 1 0 100-2H7zm0 4a1 1 0 000 2h2a1 1 0 100-2H7z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-white font-semibold">Limited Time Sales</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Filter Section -->
  <!-- <section class="py-12 bg-gradient-to-br from-cream via-white to-cream">
    <div class="container mx-auto px-4">
      <div class="flex flex-wrap gap-4 justify-center mb-8">
        <button class="px-6 py-3 bg-maroon text-white rounded-full font-semibold hover:bg-maroon/80 transition-all duration-300 transform hover:scale-105">
          All Sales
        </button>
        <button class="px-6 py-3 bg-white text-maroon border-2 border-maroon rounded-full font-semibold hover:bg-maroon/10 transition-all duration-300 transform hover:scale-105">
          Clothing
        </button>
        <button class="px-6 py-3 bg-white text-maroon border-2 border-maroon rounded-full font-semibold hover:bg-maroon/10 transition-all duration-300 transform hover:scale-105">
          Accessories
        </button>
        <button class="px-6 py-3 bg-white text-maroon border-2 border-maroon rounded-full font-semibold hover:bg-maroon/10 transition-all duration-300 transform hover:scale-105">
          Home Decor
        </button>
      </div>
    </div>
  </section> -->

  <!-- Sales Grid -->
  <section class="py-16 bg-gradient-to-br from-cream via-white to-cream">
    <div class="container mx-auto px-4">
      {activeSales.length === 0 ? (
        <div class="text-center py-20">
          <div class="max-w-2xl mx-auto">
            <!-- Empty State Icon -->
            <div class="mb-8">
              <div class="w-32 h-32 mx-auto bg-gradient-to-br from-maroon/10 to-gold/10 rounded-full flex items-center justify-center">
                <svg class="w-16 h-16 text-maroon/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
              </div>
            </div>
            
            <!-- Empty State Message -->
            <h2 class="font-playfair text-3xl md:text-4xl font-bold text-maroon mb-4">
              No Sales Available Right Now
            </h2>
            <p class="text-xl text-dark/80 mb-8 leading-relaxed">
              We're working on bringing you amazing deals and special sales. 
              Check back soon for exciting discounts on authentic Indian handcrafted treasures!
            </p>
            
            <!-- Call to Action -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
              <a 
                href="/shop" 
                class="bg-maroon text-white px-8 py-4 rounded-full font-semibold hover:bg-maroon/80 transition-all duration-300 transform hover:scale-105 shadow-lg"
              >
                <span class="flex items-center">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                  </svg>
                  Browse Our Collection
                </span>
              </a>
              
              <button class="bg-gold text-maroon px-8 py-4 rounded-full font-bold hover:bg-gold/80 transition-all duration-300 transform hover:scale-105 shadow-lg">
                <span class="flex items-center">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                  Get Notified
                </span>
              </button>
            </div>
            
            <!-- Additional Info -->
            <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="text-center">
                <div class="w-12 h-12 mx-auto bg-gold/20 rounded-full flex items-center justify-center mb-3">
                  <svg class="w-6 h-6 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <h3 class="font-semibold text-maroon mb-2">Limited Time Deals</h3>
                <p class="text-sm text-dark/60">Special sales with time-sensitive discounts</p>
              </div>
              
              <div class="text-center">
                <div class="w-12 h-12 mx-auto bg-gold/20 rounded-full flex items-center justify-center mb-3">
                  <svg class="w-6 h-6 text-gold" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                </div>
                <h3 class="font-semibold text-maroon mb-2">Exclusive Collections</h3>
                <p class="text-sm text-dark/60">Handpicked items from master artisans</p>
              </div>
              
              <div class="text-center">
                <div class="w-12 h-12 mx-auto bg-gold/20 rounded-full flex items-center justify-center mb-3">
                  <svg class="w-6 h-6 text-gold" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                  </svg>
                </div>
                <h3 class="font-semibold text-maroon mb-2">Early Access</h3>
                <p class="text-sm text-dark/60">Be the first to know about new arrivals</p>
              </div>
            </div>
          </div>
        </div>
      ) : (
        <div class="space-y-12">
          {salesWithProducts.map((sale, index) => {
            return (
              <div class="bg-white rounded-2xl shadow-xl overflow-hidden" key={sale.id}>
                <!-- Sale Header -->
                <div class="bg-gradient-to-r from-maroon to-maroon/80 p-6 text-white">
                  <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div>
                      <div class="flex items-center gap-4 mb-4">
                        <div class="bg-gold text-maroon px-4 py-2 rounded-full text-lg font-bold shadow-lg">
                          {sale.discount_type === 'percentage' ? `${sale.discount_value}% OFF` : `₹${sale.discount_value} OFF`}
                        </div>
                        <div class="text-sm opacity-90">
                          Valid until: {new Date(sale.ends_at).toLocaleDateString()}
                        </div>
                      </div>
                      <h3 class="font-playfair text-3xl font-bold mb-2">
                        {sale.title}
                      </h3>
                      <p class="text-white/90 leading-relaxed">
                        {sale.description}
                      </p>
                    </div>
                    <div class="mt-4 md:mt-0">
                      <div class="text-sm text-white/80 mb-2">Applies to:</div>
                      <div class="font-semibold capitalize">
                        {sale.applies_to === 'all' ? 'All Products' : 
                         sale.applies_to === 'products' ? `${sale.applies_to_ids.length} Selected Product Variants` :
                         sale.applies_to === 'categories' ? `${sale.applies_to_ids.length} Categories` :
                         'Selected Collections'}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Products Grid -->
                {sale.products.length > 0 ? (
                  <div class="p-6">
                    <h4 class="text-xl font-semibold text-maroon mb-6">Products in this sale ({sale.products.length})</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                      {sale.products.map((product) => {
                        const originalPrice = product.price_cents;
                        const discountedPrice = getDiscountedPrice(originalPrice, sale.discount_type, sale.discount_value);
                        const savings = originalPrice - discountedPrice;
                        const discountPercentage = Math.round((savings / originalPrice) * 100);
                        
                        return (
                          <div class="group bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-all duration-300 hover:-translate-y-1" key={product.id}>
                            <div class="aspect-square bg-gray-100 relative overflow-hidden">
                              {product.image_url ? (
                                <img 
                                  src={product.image_url} 
                                  alt={product.title}
                                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                />
                              ) : (
                                <div class="w-full h-full bg-gradient-to-br from-maroon/10 to-gold/10 flex items-center justify-center">
                                  <svg class="w-12 h-12 text-maroon/30" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                  </svg>
                                </div>
                              )}
                              {savings > 0 && (
                                <div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                                  -{discountPercentage}%
                                </div>
                              )}
                            </div>
                            <div class="p-4">
                              <h5 class="font-semibold text-dark mb-2 line-clamp-2 group-hover:text-maroon transition-colors">
                                {product.title}
                              </h5>
                              <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                  {savings > 0 ? (
                                    <>
                                      <span class="text-lg font-bold text-maroon">
                                        ₹{formatPrice(discountedPrice)}
                                      </span>
                                      <span class="text-sm text-gray-500 line-through">
                                        ₹{formatPrice(originalPrice)}
                                      </span>
                                    </>
                                  ) : (
                                    <span class="text-lg font-bold text-dark">
                                      ₹{formatPrice(originalPrice)}
                                    </span>
                                  )}
                                </div>
                                {product.stock_quantity > 0 ? (
                                  <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                                    In Stock
                                  </span>
                                ) : (
                                  <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">
                                    Out of Stock
                                  </span>
                                )}
                              </div>
                              <a 
                                href={`/product/${product.slug}`}
                                class="mt-3 block w-full bg-gradient-to-r from-maroon to-maroon/80 text-white px-4 py-2 rounded-lg text-center font-semibold hover:from-gold hover:to-gold/80 transition-all duration-300 transform hover:scale-105"
                              >
                                View Details
                              </a>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ) : (
                  <div class="p-6 text-center text-gray-500">
                    <div>
                      <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                      </svg>
                      <p>No products available for this sale at the moment.</p>
                      <p class="text-sm mt-2">Please check back later or contact support for assistance.</p>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  </section>

  <!-- Newsletter Section -->
  <section class="py-20 bg-gradient-to-r from-maroon to-maroon/80 relative overflow-hidden">
    <div class="absolute inset-0">
      <div class="absolute top-10 left-20 w-64 h-64 bg-gold/20 rounded-full blur-3xl animate-pulse"></div>
      <div class="absolute bottom-10 right-20 w-80 h-80 bg-white/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
    </div>
    
    <div class="container mx-auto px-4 relative z-10">
      <div class="max-w-2xl mx-auto text-center text-white">
        <h2 class="font-playfair text-3xl md:text-4xl font-bold mb-6">
          Never Miss a Deal
        </h2>
        <p class="text-xl mb-8 max-w-2xl mx-auto">
          Subscribe to our newsletter and get exclusive sales delivered to your inbox
        </p>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center items-center max-w-md mx-auto">
          <input 
            type="email" 
            placeholder="Enter your email address"
            class="flex-1 px-6 py-4 rounded-full text-dark focus:outline-none focus:ring-4 focus:ring-gold/50"
          />
          <button class="bg-gold text-maroon px-8 py-4 rounded-full font-bold hover:bg-gold/80 transition-all duration-300 transform hover:scale-105 shadow-lg">
            Subscribe
          </button>
        </div>
        
        <p class="text-sm mt-6 text-white/80">
          Join 10,000+ subscribers getting exclusive access to limited-time sales
        </p>
      </div>
    </div>
  </section>

  <Footer />
</Layout>
