---
import { fetchCategories } from '../lib/api';

// Fetch categories from API to get R2 images
let allCategories = [];
try {
  const categoriesData = await fetchCategories();
  allCategories = categoriesData.items || [];
} catch (error) {
  console.error('Error fetching categories:', error);
  // No fallback categories - if API fails, show no categories
  allCategories = [];
}

// Transform categories to display format
const displayCategories = allCategories
  .filter(category => category.image_url) // Only show categories with images
  .map(category => {
    return {
      name: category.name,
      image: category.image_url,
      href: `/shop?category=${category.slug}`,
      description: category.description || `Discover our ${category.name} collection`
    };
  });

---

<section class="py-20 bg-gradient-to-br from-cream via-white to-cream relative overflow-hidden">
  <!-- Decorative Background Elements -->
  <div class="absolute top-10 left-10 w-32 h-32 bg-gold/10 rounded-full blur-3xl animate-pulse"></div>
  <div class="absolute bottom-10 right-10 w-40 h-40 bg-maroon/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 1s"></div>
  
  <div class="container mx-auto px-4 relative z-10">
    <!-- Section Header -->
    <div class="text-center mb-16 animate-fade-in">
      <h2 class="font-playfair text-4xl md:text-5xl font-bold text-maroon mb-6 relative inline-block">
        Shop by Category
        <span class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-32 h-1 bg-gradient-to-r from-transparent via-gold to-transparent animate-gold-shine"></span>
      </h2>
      <div class="w-32 h-1 bg-gold mx-auto mb-8 shadow-gold"></div>
      <p class="text-lg md:text-xl text-dark/80 max-w-3xl mx-auto leading-relaxed font-light">
        Discover our curated collection of handcrafted bags and throws, each piece crafted with care and attention to detail
      </p>
    </div>

    <!-- Category Slider -->
    <div class="relative overflow-hidden mb-12">
      {displayCategories.length > 0 ? (
        <div class="flex transition-transform duration-1000 ease-in-out" id="categorySlider">
          {displayCategories.map((category, index) => (
          <div class="w-full md:w-1/3 flex-shrink-0 px-2 md:px-4">
            <a 
              href={category.href}
              class="group relative overflow-hidden rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-700 transform hover:scale-105"
            >
              <!-- Category Card Container -->
              <div class="relative h-48 md:h-64 lg:h-72 overflow-hidden bg-white">
                <!-- Image with Enhanced Effects -->
                <div class="relative w-full h-full">
                  <picture>
                    <source srcset={category.image} type="image/webp">
                    <source srcset={category.image.replace('.webp', '.png')} type="image/png">
                    <img 
                      src={category.image}
                      alt={category.name}
                      class="w-full h-full object-cover transition-all duration-700 group-hover:scale-110 group-hover:brightness-110"
                      loading="lazy"
                    />
                  </picture>
                  
                  <!-- Overlay Gradient -->
                  <div class="absolute inset-0 bg-gradient-to-t from-maroon/90 via-maroon/40 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-500"></div>
                  
                  <!-- Hover Content -->
                  <div class="absolute bottom-0 left-0 right-0 p-4 md:p-6 text-white transform translate-y-full group-hover:translate-y-0 transition-transform duration-500">
                    <p class="text-xs md:text-sm lg:text-base mb-2 md:mb-3 leading-relaxed">{category.description}</p>
                    <div class="flex items-center justify-between">
                      <span class="text-gold font-semibold text-xs md:text-sm lg:text-base flex items-center gap-2">
                        Shop Now 
                        <svg class="w-3 h-3 md:w-4 md:h-4 transform group-hover:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </span>
                    </div>
                  </div>
                </div>
                
                <!-- Category Badge -->
                <div class="absolute top-2 md:top-4 left-2 md:left-4 bg-gradient-to-r from-gold to-gold/80 text-maroon px-2 py-1 md:px-4 md:py-2 rounded-full font-semibold text-xs md:text-sm lg:text-base shadow-lg backdrop-blur-sm transform group-hover:scale-110 transition-transform duration-300">
                  {category.name}
                </div>
                
                <!-- Decorative Corner Accent -->
                <div class="absolute top-1 md:top-2 right-1 md:right-2 w-4 h-4 md:w-8 md:h-8 border-t border-r border-gold/50 transform rotate-45 group-hover:scale-150 transition-transform duration-500"></div>
              </div>
              
              <!-- Card Border Effect -->
              <div class="absolute inset-0 rounded-2xl border-2 border-transparent group-hover:border-gold/50 transition-all duration-500 pointer-events-none"></div>
            </a>
          </div>
        ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="text-gray-400 text-lg">
            Categories are currently unavailable. Please check back later.
          </div>
        </div>
      )}
      
      <!-- Slider Navigation Dots -->
      {displayCategories.length > 1 && (
        <div class="flex justify-center mt-4 md:mt-6 space-x-1 md:space-x-2" id="sliderDots">
          {displayCategories.map((_, index) => (
            <button 
              class={`w-1.5 h-1.5 md:w-2 md:h-2 rounded-full transition-all duration-300 ${index === 0 ? 'bg-maroon' : 'bg-gray-300'}`}
              onclick={`goToSlide(${index})`}
              data-slide={index}
              style={index === 0 ? "width: 2rem;" : ""}
            ></button>
          ))}
        </div>
      )}
    </div>
    
    <!-- View All Button -->
    <div class="text-center mt-16 animate-fade-up" style="animation-delay: 0.8s">
      <a 
        href="/categories" 
        class="inline-flex items-center gap-3 bg-maroon text-white px-8 py-4 rounded-full font-semibold text-lg hover:bg-gold hover:text-maroon transition-all duration-500 transform hover:scale-105 shadow-lg hover:shadow-gold"
      >
        View All Categories
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
        </svg>
      </a>
    </div>
  </div>
</section>

<script define:vars={{ totalCategories: displayCategories.length }}>
  // Category slider functionality
  let currentSlide = 0;
  const totalSlides = totalCategories;
  let slidesPerView = 3; // Default for desktop
  const slideInterval = 3000; // 3 seconds
  
  // Function to get slides per view based on screen width
  function getSlidesPerView() {
    if (typeof window !== 'undefined') {
      const width = window.innerWidth;
      if (width < 768) { // Mobile
        return 1;
      } else if (width < 1024) { // Tablet
        return 2;
      } else { // Desktop
        return 3;
      }
    }
    return 3; // Default
  }
  
  // Update slides per view on window resize
  function updateSlidesPerView() {
    const newSlidesPerView = getSlidesPerView();
    if (newSlidesPerView !== slidesPerView) {
      slidesPerView = newSlidesPerView;
      // Reset to first slide when layout changes
      goToSlide(0);
    }
  }
  
  function goToSlide(slideIndex) {
    const slider = document.getElementById('categorySlider');
    const maxSlide = Math.max(0, totalSlides - slidesPerView);
    
    // Ensure slideIndex is within bounds
    if (slideIndex < 0) slideIndex = maxSlide;
    if (slideIndex > maxSlide) slideIndex = 0;
    
    currentSlide = slideIndex;
    
    // Calculate translate value based on current slides per view
    const translateValue = -(currentSlide * (100 / slidesPerView));
    slider.style.transform = `translateX(${translateValue}%)`;
    
    // Update dots
    updateDots();
  }
  
  function nextSlide() {
    const maxSlide = Math.max(0, totalSlides - slidesPerView);
    goToSlide(currentSlide >= maxSlide ? 0 : currentSlide + 1);
  }
  
  function updateDots() {
    const dots = document.querySelectorAll('#sliderDots button');
    dots.forEach((dot, index) => {
      if (index === currentSlide) {
        dot.classList.remove('bg-gray-300');
        dot.classList.add('bg-maroon');
        // Responsive dot width
        if (typeof window !== 'undefined' && window.innerWidth < 768) {
          dot.style.width = '1rem'; // w-4
        } else {
          dot.style.width = '2rem'; // w-8
        }
      } else {
        dot.classList.remove('bg-maroon');
        dot.classList.add('bg-gray-300');
        dot.style.width = ''; // Reset to default
      }
    });
  }
  
  // Auto-slide functionality
  let autoSlideInterval;
  
  function startAutoSlide() {
    if (totalSlides > slidesPerView) {
      autoSlideInterval = setInterval(() => {
        nextSlide();
      }, slideInterval);
    } else {
    }
  }
  
  function stopAutoSlide() {
    if (autoSlideInterval) {
      clearInterval(autoSlideInterval);
    }
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    // Update slides per view based on current screen size
    updateSlidesPerView();
    
    
    if (totalSlides > 0) {
      // Wait a bit for DOM to be fully ready
      setTimeout(() => {
        const slider = document.getElementById('categorySlider');
        
        if (slider) {
          goToSlide(0);
          startAutoSlide();
          
          // Pause auto-slide on hover
          const sliderContainer = document.querySelector('.relative.overflow-hidden');
          if (sliderContainer) {
            sliderContainer.addEventListener('mouseenter', stopAutoSlide);
            sliderContainer.addEventListener('mouseleave', startAutoSlide);
          }
        }
      }, 100);
    }
    
    // Add resize listener
    if (typeof window !== 'undefined') {
      window.addEventListener('resize', updateSlidesPerView);
    }
  });
  
  // Make function globally available for onclick handlers
  window.goToSlide = goToSlide;
</script>
