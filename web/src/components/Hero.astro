---
// Hero section with dynamic banner carousel
import { fetchBanners, type Banner } from '../lib/apiBanner';

// Fallback images for when no banners are available
const fallbackImages = [
  'https://pub-1a3924a6c6994107be6fe9f3ed794c0a.r2.dev/banner/fallback1.jpg',
  'https://pub-1a3924a6c6994107be6fe9f3ed794c0a.r2.dev/banner/fallback2.jpg', 
  'https://pub-1a3924a6c6994107be6fe9f3ed794c0a.r2.dev/banner/fallback3.jpg'
];

let banners: Banner[] = [];
let slides: string[] = [];
let slideTitles: string[] = [];
let slideLinks: (string | undefined)[] = [];
let currentSlide = 0;

// Initialize banners on component load
await initBanners();

async function initBanners() {
  try {
    const response = await fetchBanners();
    banners = response.items || [];
    
    // Prepare slides: use DB banners first, then fallback images to ensure exactly 3 slides
    slides = [];
    slideTitles = [];
    slideLinks = [];
    
    // Add dynamic banners - use image_url from API response
    for (const banner of banners) {
      if (slides.length < 4 && banner.image_url) {
        slides.push(banner.image_url);
        slideTitles.push(banner.title);
        slideLinks.push(banner.link_url);
      }
    }

    // If no DB banners, fall back to R2 images
    if (slides.length === 0) {
      slides = fallbackImages;
      slideTitles = fallbackImages.map(() => 'Ethnic Treasure Collection');
      slideLinks = fallbackImages.map(() => undefined);
    }
  } catch (error) {
    console.error('Error initializing banners:', error);
    // Use only fallback images if there's an error
    slides = fallbackImages;
    slideTitles = fallbackImages.map(() => 'Ethnic Treasure Collection');
    slideLinks = fallbackImages.map(() => undefined);
  }
}

---

<script is:inline type="application/json" id="hero-slides-data" set:html={JSON.stringify({ slides, slideTitles, slideLinks })} />

<script is:inline>
  const __debugHero = (() => {
    try {
      return new URLSearchParams(window.location.search).has('debugHero');
    } catch {
      return false;
    }
  })();

  const __heroLog = (...args) => {
    if (__debugHero) console.log('[HeroSlider]', ...args);
  };

  const slidesDataEl = document.getElementById('hero-slides-data');
  const slidesData = (() => {
    try {
      const parsed = JSON.parse(slidesDataEl?.textContent || '{"slides":[],"slideTitles":[],"slideLinks":[]}');
      __heroLog('parsed slidesData', {
        slidesCount: parsed?.slides?.length,
        titlesCount: parsed?.slideTitles?.length,
        linksCount: parsed?.slideLinks?.length,
        slides: parsed?.slides,
        slideLinks: parsed?.slideLinks,
      });
      return parsed;
    } catch {
      __heroLog('failed to parse slidesData JSON', { jsonText: slidesDataEl?.textContent });
      return { slides: [], slideTitles: [], slideLinks: [] };
    }
  })();

  const initHero = () => {
    __heroLog('initHero start');
    const scrollIndicator = document.querySelector('[data-scroll-indicator]');
    if (scrollIndicator) {
      scrollIndicator.addEventListener('click', () => {
        const nextSection = document.querySelector('section:nth-child(2)');
        if (nextSection) {
          nextSection.scrollIntoView({ behavior: 'smooth' });
        } else {
          window.scrollBy({ top: window.innerHeight, behavior: 'smooth' });
        }
      });
    }

    const heroImage = document.querySelector('[data-hero-image]');
    const heroButton = document.querySelector('[data-hero-button]');
    const dots = document.querySelectorAll('[data-hero-dot]');

    __heroLog('dom elements', {
      heroImage: !!heroImage,
      heroButton: !!heroButton,
      dotsCount: dots?.length,
      slidesCount: slidesData?.slides?.length,
    });

    if (!heroImage) {
      setTimeout(initHero, 50);
      return;
    }
    let currentSlideIndex = 0;

    function updateSlideContent() {
      if (heroImage && slidesData.slides.length > 0) {
        __heroLog('updateSlideContent', { currentSlideIndex, url: slidesData.slides[currentSlideIndex] });
        heroImage.style.opacity = '0';

        setTimeout(() => {
          heroImage.src = slidesData.slides[currentSlideIndex];
          heroImage.alt = slidesData.slideTitles[currentSlideIndex] || 'Premium ethnic fashion';

          if (heroButton && slidesData.slideLinks[currentSlideIndex]) {
            heroButton.href = slidesData.slideLinks[currentSlideIndex];
            heroButton.style.display = 'inline-block';
            __heroLog('cta show', { href: heroButton.href });
          } else if (heroButton) {
            heroButton.style.display = 'none';
            __heroLog('cta hide');
          }

          heroImage.style.opacity = '1';

          // Update dots
          dots.forEach((dot, index) => {
            if (index === currentSlideIndex) {
              dot.classList.add('opacity-70');
              dot.classList.remove('opacity-50');
            } else {
              dot.classList.remove('opacity-70');
              dot.classList.add('opacity-50');
            }
          });
        }, 500);
      }
    }

    function changeSlide() {
      if (slidesData.slides.length > 1) {
        currentSlideIndex = (currentSlideIndex + 1) % slidesData.slides.length;
        __heroLog('changeSlide tick', { currentSlideIndex });
        updateSlideContent();
      }
    }

    updateSlideContent();
    if (slidesData.slides.length > 1) {
      if (window.__heroIntervalId) clearInterval(window.__heroIntervalId);
      window.__heroIntervalId = setInterval(changeSlide, 3000);
      __heroLog('interval started', { intervalMs: 3000, id: window.__heroIntervalId });
    } else {
      __heroLog('interval not started (slides <= 1)', { slidesCount: slidesData?.slides?.length });
    }

    // Add event listeners to dots
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        currentSlideIndex = index;
        updateSlideContent();
      });
    });
  };

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initHero);
  else initHero();
</script>

<section class="relative w-full overflow-hidden h-[22vh] sm:h-[26vh] md:h-[42vh] lg:h-[50vh] min-h-[180px] md:min-h-[320px] max-h-[700px]">
  <!-- Hero Image Slideshow -->
  <div class="relative w-full h-full">
    <img 
      data-hero-image
      src={slides[0] || fallbackImages[0]} 
      alt={slideTitles[0] || 'Premium ethnic fashion model wearing traditional Indian attire'}
      class="w-full h-full object-cover object-center transition-opacity duration-500 ease-in-out"
      loading="eager"
    />
  </div>

  <!-- Slide Indicators -->
  <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex space-x-2 z-20">
    {slides.map((_, index) => (
      <button
        type="button"
        data-hero-dot
        data-hero-dot-index={index}
        class={index === 0 ? 'w-2 h-2 bg-white rounded-full opacity-70 transition-opacity' : 'w-2 h-2 bg-white/50 rounded-full opacity-50 transition-opacity'}
        aria-label={`Go to slide ${index + 1}`}
      ></button>
    ))}
  </div>

  <!-- Overlay Gradient -->
  <div class="absolute inset-0 bg-gradient-to-r from-maroon/70 via-maroon/30 to-transparent z-5"></div>

  <!-- Hero Content -->
  <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
    <div class="container mx-auto px-4 text-center text-white animate-fade-in">
      <a 
        data-hero-button
        href={slideLinks[0] || '#'}
        style={slideLinks[0] ? 'display: inline-block;' : 'display: none;'}
        class="absolute bottom-6 left-6 bg-maroon text-cream px-6 py-3 rounded-md hover:bg-maroon/90 transition-colors duration-300 font-semibold pointer-events-auto"
      >
        Explore Now
      </a>
    </div>
  </div>

	<!-- Decorative Ethnic SVG Motif -->
	<div class="absolute bottom-5 sm:bottom-10 left-5 sm:left-10 text-gold/20 animate-pulse">
		<svg width="80" height="80" class="sm:w-100 sm:h-100 md:w-120 md:h-120" viewBox="0 0 120 120" fill="currentColor">
			<path d="M60 10 L70 40 L100 40 L75 60 L85 90 L60 70 L35 90 L45 60 L20 40 L50 40 Z"/>
		</svg>
	</div>

	<div class="absolute top-5 sm:top-10 right-5 sm:right-10 text-gold/20 animate-pulse" style="animation-delay: 1s">
		<svg width="60" height="60" class="sm:w-70 sm:h-70 md:w-80 md:h-80" viewBox="0 0 80 80" fill="currentColor">
			<circle cx="40" cy="40" r="35" fill="none" stroke="currentColor" stroke-width="2"/>
			<circle cx="40" cy="40" r="25" fill="none" stroke="currentColor" stroke-width="1"/>
			<circle cx="40" cy="40" r="15" fill="none" stroke="currentColor" stroke-width="1"/>
		</svg>
	</div>

	<!-- Scroll Indicator -->
	<div 
		data-scroll-indicator
		class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-white animate-bounce cursor-pointer hover:text-gold transition-colors duration-300"
	>
		<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
		</svg>
	</div>
</section>
