---
// Pure Astro search component with client-side script for interactivity
const PUBLIC_API = import.meta.env.PUBLIC_API_URL || 'https://etreasure-1.onrender.com';
---

<div class="search-container w-full max-w-md mx-auto relative" data-api-base={PUBLIC_API}>
  <div class="relative">
    <input
      class="search-input w-full px-4 py-2 border border-gold/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-gold/50 focus:border-transparent placeholder:text-dark/40 text-dark"
      type="text"
      placeholder="Search products..."
      aria-label="Search products"
      aria-autocomplete="list"
      aria-expanded="false"
      aria-controls="search-suggestions"
    />
    <svg
      class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gold pointer-events-none"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      />
    </svg>
  </div>

  <!-- Suggestions Dropdown -->
  <div
    class="search-suggestions absolute top-full left-0 right-0 mt-2 bg-white border border-gold/20 rounded-lg shadow-xl z-[60] max-h-96 overflow-y-auto hidden"
  >
    <div class="suggestions-content"></div>
  </div>
</div>

<script>
  (function () {
    const MIN_LETTERS = 3;
    const alphaRe = /[A-Za-z]/;

    // Initialize one widget per container instance
    document.querySelectorAll('.search-container').forEach((container) => {
      const searchInput = container.querySelector('.search-input');
      const suggestionsDropdown = container.querySelector('.search-suggestions');
      const suggestionsContent = container.querySelector('.suggestions-content');
      const API_BASE = container.dataset && container.dataset.apiBase ? container.dataset.apiBase : '';

      if (!searchInput) return;

      let debounceTimer = null;
      let currentQuery = '';

      async function fetchSuggestions(query) {
        if (!query || !query.trim() || query.length < MIN_LETTERS || !alphaRe.test(query)) {
          suggestionsDropdown && suggestionsDropdown.classList.add('hidden');
          searchInput.setAttribute('aria-expanded', 'false');
          return;
        }

        try {
          const endpoint = API_BASE && API_BASE.length > 0 ? `${API_BASE.replace(/\/$/, '')}/api/search/suggest` : `/api/search/suggest`;
          const url = new URL(endpoint, window.location.origin);
          url.searchParams.set('q', query);
          url.searchParams.set('limit', '8');

          const response = await fetch(url.toString(), { credentials: 'same-origin' });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          const results = data.results || [];

          if (!suggestionsContent) return;
          suggestionsContent.innerHTML = '';

          if (results.length === 0) {
            suggestionsContent.innerHTML = `<div class="p-4 text-center text-dark/60 text-sm">No products found for "${query}"</div>`;
          } else {
            const ul = document.createElement('ul');
            ul.className = 'divide-y divide-gold/10';

            results.forEach((result) => {
              const li = document.createElement('li');
              li.innerHTML = `
                <a href="${result.link}" class="flex items-center gap-3 p-3 hover:bg-maroon/5 transition-colors">
                  ${result.image ? `<img src="https://pub-1a3924a6c6994107be6fe9f3ed794c0a.r2.dev/${result.image}" alt="${result.title}" class="w-12 h-12 object-cover rounded">` : ''}
                  <div class="flex-1 min-w-0">
                    <p class="font-medium text-dark truncate text-sm">${result.title}</p>
                    ${result.price ? `<p class="text-gold font-semibold text-sm">â‚¹${result.price}</p>` : ''}
                  </div>
                </a>
              `;
              ul.appendChild(li);
            });

            suggestionsContent.appendChild(ul);

            const viewAllBtn = document.createElement('button');
            viewAllBtn.className = 'w-full p-3 text-center text-gold hover:bg-gold/5 font-medium text-sm border-t border-gold/10 transition-colors';
            viewAllBtn.textContent = `View all results for "${query}"`;
            viewAllBtn.onclick = (e) => {
              e.preventDefault();
              window.location.href = `/search?q=${encodeURIComponent(query)}`;
            };
            suggestionsContent.appendChild(viewAllBtn);
          }

          suggestionsDropdown && suggestionsDropdown.classList.remove('hidden');
          searchInput.setAttribute('aria-expanded', 'true');
        } catch (error) {
                    suggestionsDropdown && suggestionsDropdown.classList.add('hidden');
        }
      }

      function handleInputChange(e) {
        const target = e.target;
        currentQuery = target && target.value ? target.value : '';

        if (debounceTimer) clearTimeout(debounceTimer);

        if (currentQuery.length >= MIN_LETTERS && alphaRe.test(currentQuery)) {
          debounceTimer = setTimeout(() => fetchSuggestions(currentQuery), 250);
        } else {
          suggestionsDropdown && suggestionsDropdown.classList.add('hidden');
          searchInput.setAttribute('aria-expanded', 'false');
        }
      }

      function handleKeyDown(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (currentQuery.trim()) window.location.href = `/search?q=${encodeURIComponent(currentQuery)}`;
        } else if (e.key === 'Escape') {
          suggestionsDropdown && suggestionsDropdown.classList.add('hidden');
          searchInput.setAttribute('aria-expanded', 'false');
        }
      }

      function handleClickOutside(e) {
        if (!container.contains(e.target)) {
          suggestionsDropdown && suggestionsDropdown.classList.add('hidden');
          searchInput.setAttribute('aria-expanded', 'false');
        }
      }

      searchInput.addEventListener('input', handleInputChange);
      searchInput.addEventListener('keydown', handleKeyDown);
      searchInput.addEventListener('focus', () => {
        if (currentQuery.length >= MIN_LETTERS && alphaRe.test(currentQuery)) {
          suggestionsDropdown && suggestionsDropdown.classList.remove('hidden');
          searchInput.setAttribute('aria-expanded', 'true');
        }
      });

      document.addEventListener('mousedown', handleClickOutside);
    });
  })();
</script>
